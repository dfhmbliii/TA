<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasil Analisis SPK</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-soft: #eef2ff;
            --surface: #ffffff;
            --muted: #6b7280;
            --border: #e5e7eb;
            --gray-bg: #f7f8fb;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gray-bg);
            color: #111827;
        }

        .page {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: var(--gray-bg);
        }

        .page-header { margin-bottom: 16px; }
        .page-title { font-size: 20px; font-weight: 800; margin: 0 0 6px 0; }
        .page-subtitle { margin: 0; color: var(--muted); font-size: 13px; }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .card-header { font-weight: 700; margin-bottom: 10px; font-size: 14px; }

        .recommendation { display: flex; flex-direction: column; gap: 12px; }
        .prodi-name { font-size: 18px; font-weight: 800; margin: 0; color: #1f2937; }
        .prodi-meta { color: var(--muted); font-size: 12px; margin: 0; }

        .score-grid { display: flex; align-items: center; gap: 12px; }
        .score-box { padding: 10px 12px; background: var(--primary-soft); border-radius: 10px; border: 1px solid var(--border); }
        .score-value { font-size: 24px; font-weight: 800; margin: 0; }
        .score-label { font-size: 11px; color: var(--muted); margin: 4px 0 0 0; }
        .category-pill { display: inline-block; padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: 12px; background: var(--primary-soft); color: #312e81; border: 1px solid #c7d2fe; }
        .muted-text { color: var(--muted); font-size: 12px; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border: 1px solid var(--border); font-size: 12px; text-align: left; }
        th { background: #f9fafb; font-weight: 700; color: #374151; }

        .badge { display: inline-block; padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: 11px; }
        .badge-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .badge-warning { background: #fef9c3; color: #854d0e; border: 1px solid #fde68a; }
        .badge-success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge-info { background: #e0f2fe; color: #075985; border: 1px solid #bae6fd; }

        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; }
        .list-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--border); }
        .list-row:last-child { border-bottom: none; }

        .footer { text-align: center; margin-top: 20px; padding-top: 12px; border-top: 1px solid var(--border); color: var(--muted); font-size: 11px; page-break-inside: avoid; }

        @page { margin: 15mm; size: A4; }
        .page-break { page-break-after: always; }
    </style>
</head>
<body>
    <div class="page">
        <div class="page-header">
            <div class="page-title">Hasil Analisis SPK</div>
            <p class="page-subtitle">Rekomendasi Program Studi berdasarkan minat, bakat, dan kemampuan Anda</p>
        </div>

        @php
            $inputData = is_array($result->input_data) ? $result->input_data : json_decode($result->input_data, true);
            $nilaiMapel = isset($inputData['nilai_mapel']) ? (is_array($inputData['nilai_mapel']) ? $inputData['nilai_mapel'] : json_decode($inputData['nilai_mapel'], true)) : [];
            $avgNilai = count($nilaiMapel) > 0 ? number_format(array_sum(array_map('floatval', $nilaiMapel)) / count($nilaiMapel), 2) : '-';

            $criteriaValues = is_array($result->criteria_values) ? $result->criteria_values : json_decode($result->criteria_values ?? '[]', true);
            $minatValue = isset($criteriaValues['minat']) ? number_format($criteriaValues['minat'], 2) : '0.00';
            $bakatValue = isset($criteriaValues['bakat']) ? number_format($criteriaValues['bakat'], 2) : '0.00';
            $karirValue = isset($criteriaValues['prospek_karir']) ? number_format($criteriaValues['prospek_karir'], 2) : '0.00';
            $akademikValue = isset($criteriaValues['akademik']) ? number_format($criteriaValues['akademik'], 2) : '0.00';

            $weights = is_array($result->weights) ? $result->weights : json_decode($result->weights ?? '[]', true);
            $minatWeight = isset($weights['minat']) ? floatval($weights['minat']) : 0;
            $bakatWeight = isset($weights['bakat']) ? floatval($weights['bakat']) : 0;
            $karirWeight = isset($weights['prospek_karir']) ? floatval($weights['prospek_karir']) : 0;
            $akademikWeight = isset($weights['akademik']) ? floatval($weights['akademik']) : 0;

            $prodiRec = $result->rekomendasi_prodi;
            if (is_string($prodiRec)) {
                $prodiRec = json_decode($prodiRec, true);
            }
            $prodiScore = isset($prodiRec['score']) ? floatval($prodiRec['score']) : $result->total_score;
            $scoreCategory = $prodiScore >= 80 ? 'Sangat Sesuai' : ($prodiScore >= 70 ? 'Sesuai' : ($prodiScore >= 60 ? 'Cukup Sesuai' : 'Kurang Sesuai'));
        @endphp

        <div class="card">
            <div class="card-header">Rekomendasi Terbaik</div>
            <div class="recommendation">
                <div>
                    <p class="prodi-name">{{ $prodiRec['nama_prodi'] ?? 'Program Studi Belum Tersedia' }}</p>
                    <p class="prodi-meta">{{ $prodiRec['nama_fakultas'] ?? ($prodiRec['kode_prodi'] ?? '') }}</p>
                </div>
                <div class="score-grid">
                    <div class="score-box">
                        <p class="score-value">{{ number_format($prodiScore, 2) }}</p>
                        <p class="score-label">Skor Total</p>
                    </div>
                    <div class="score-box">
                        <span class="category-pill">{{ $scoreCategory }}</span>
                        <p class="score-label" style="margin-top:6px;">Kategori</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Data Input Anda</div>
            <table>
                <thead>
                    <tr>
                        <th>Minat</th>
                        <th>Bakat</th>
                        <th>Prospek Karir</th>
                        <th>Nilai Rata-rata</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge badge-danger">{{ isset($inputData['minat']) ? ucwords(str_replace('_', ' ', $inputData['minat'])) : '-' }}</span></td>
                        <td><span class="badge badge-warning">{{ isset($inputData['bakat']) ? ucwords(str_replace('_', ' ', $inputData['bakat'])) : '-' }}</span></td>
                        <td><span class="badge badge-success">{{ isset($inputData['prospek_karir']) ? ucwords(str_replace('_', ' ', $inputData['prospek_karir'])) : '-' }}</span></td>
                        <td><span class="badge badge-info">{{ $avgNilai }}</span></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="grid-2">
            <div class="card">
                <div class="card-header">Ringkasan Skor</div>
                <div class="list-row"><span class="muted-text">Total Skor</span><strong>{{ number_format($result->total_score, 2) }}</strong></div>
                <div class="list-row"><span class="muted-text">Kategori</span><span class="category-pill">{{ $result->category }}</span></div>
                <div class="list-row"><span class="muted-text">Tanggal Analisis</span><strong>{{ $result->created_at->format('d F Y, H:i') }}</strong></div>
            </div>
            <div class="card">
                <div class="card-header">Nilai Kriteria</div>
                <div class="list-row"><span class="muted-text">Minat</span><strong>{{ $minatValue }}</strong></div>
                <div class="list-row"><span class="muted-text">Bakat</span><strong>{{ $bakatValue }}</strong></div>
                <div class="list-row"><span class="muted-text">Prospek Karir</span><strong>{{ $karirValue }}</strong></div>
                <div class="list-row"><span class="muted-text">Akademik</span><strong>{{ $akademikValue }}</strong></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Bobot Kriteria</div>
            <table>
                <thead>
                    <tr>
                        <th>Kriteria</th>
                        <th>Bobot (%)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Minat</td><td>{{ $minatWeight }}%</td></tr>
                    <tr><td>Bakat</td><td>{{ $bakatWeight }}%</td></tr>
                    <tr><td>Prospek Karir</td><td>{{ $karirWeight }}%</td></tr>
                    <tr><td>Akademik</td><td>{{ $akademikWeight }}%</td></tr>
                    <tr><td><strong>Total</strong></td><td><strong>100%</strong></td></tr>
                </tbody>
            </table>
        </div>

        @if(isset($prodiRec['details']) && is_array($prodiRec['details']) && count($prodiRec['details']) > 0)
        <div class="page-break"></div>
        <div class="card">
            <div class="card-header">Detail Skor Rekomendasi</div>
            <table>
                <thead>
                    <tr>
                        <th>Kriteria</th>
                        <th>Nilai</th>
                        <th>Weight</th>
                        <th>Weighted</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach($prodiRec['details'] as $key => $detail)
                    <tr>
                        <td>{{ ucwords(str_replace('_', ' ', $key)) }}</td>
                        <td>{{ number_format($detail['score'] ?? 0, 2) }}</td>
                        <td>{{ number_format(($detail['weight'] ?? 0) * 100, 0) }}%</td>
                        <td>{{ number_format($detail['weighted'] ?? 0, 2) }}</td>
                    </tr>
                    @endforeach
                </tbody>
            </table>
        </div>
        @endif

        <div class="footer">
            Dokumen ini digenerate otomatis oleh sistem PILIHANKU<br>
            © {{ date('Y') }} - Sistem Pendukung Keputusan Pemilihan Program Studi
        </div>
    </div>
</body>
</html>
        
        .weights-table th {
            padding: 14px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .weights-table td {
            padding: 14px 16px;
            font-size: 13px;
            color: #2c3e50;
            border-bottom: 1px solid #e8ecf1;
        }
        
        .weights-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .weights-table tbody tr.total-row {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            font-weight: 700;
        }
        
        .weight-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .weight-bar-fill {
            flex: 1;
            height: 6px;
            background: linear-gradient(90deg, #5B6FFF, #A78BFA);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .weight-percentage {
            font-weight: 600;
            color: #5B6FFF;
            width: 45px;
            text-align: right;
        }
        
        /* Recommendation Section */
        .recommendation-card {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.2);
        }
        
        .recommendation-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.95;
            margin-bottom: 12px;
        }
        
        .recommendation-prodi {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .recommendation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .recommendation-stat {
            display: flex;
            flex-direction: column;
        }
        
        .recommendation-stat-label {
            font-size: 11px;
            font-weight: 500;
            opacity: 0.85;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .recommendation-stat-value {
            font-size: 20px;
            font-weight: 700;
        }
        
        /* Details Grid */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .detail-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }
        
        .detail-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.85;
            margin-bottom: 8px;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 700;
        }
        
        .score-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .score-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #FCD34D, #FBBF24);
            border-radius: 4px;
        }
        
        /* Footer */
        .footer {
            position: relative;
            margin-top: 50px;
            padding: 30px 0;
            border-top: 2px solid #e8ecf1;
            text-align: center;
            font-size: 11px;
            color: #7c8ba8;
            page-break-inside: avoid;
        }
        
        .footer-text {
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .footer-note {
            font-size: 10px;
            opacity: 0.8;
            font-style: italic;
        }
        
        @page {
            margin: 15mm;
            size: A4;
        }
        
        html, body {
            height: 100%;
        }
        
        .page-break {
            page-break-after: always;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo-section">
                <h1>PILIHANKU</h1>
                <p class="header-subtitle">Sistem Pendukung Keputusan Pemilihan Program Studi</p>
            </div>
        </div>

        <!-- Student Information -->
        <div class="student-info">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Nama Siswa</span>
                    <span class="info-value">{{ $result->siswa->name }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">NISN</span>
                    <span class="info-value">{{ $result->siswa->nisn }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Email</span>
                    <span class="info-value">{{ $result->siswa->email }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Asal Sekolah</span>
                    <span class="info-value">{{ $result->siswa->asal_sekolah ?? '-' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Jurusan SMA/SMK</span>
                    <span class="info-value">{{ $result->siswa->jurusan_sma ?? '-' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Tanggal Analisis</span>
                    <span class="info-value">{{ $result->created_at->format('d F Y, H:i') }}</span>
                </div>
            </div>
        </div>

        <!-- Score Card -->
        <div class="score-card">
            <div class="score-label">TOTAL SKOR ANALISIS</div>
            <div class="score-value">{{ number_format($result->total_score, 2) }}</div>
            <span class="category-badge">
                {{ $result->category }}
            </span>
        </div>

        <!-- Input Data Section -->
        <h2 class="section-title">Data Input</h2>
        <table class="input-table">
            <thead>
                <tr>
                    <th>Minat</th>
                    <th>Bakat</th>
                    <th>Prospek Karir</th>
                    <th>Rata-rata Nilai</th>
                </tr>
            </thead>
            <tbody>
                @php
                    $inputData = is_array($result->input_data) ? $result->input_data : json_decode($result->input_data, true);
                    $nilaiMapel = isset($inputData['nilai_mapel']) ? (is_array($inputData['nilai_mapel']) ? $inputData['nilai_mapel'] : json_decode($inputData['nilai_mapel'], true)) : [];
                    $avgNilai = count($nilaiMapel) > 0 ? number_format(array_sum(array_map('floatval', $nilaiMapel)) / count($nilaiMapel), 2) : '-';
                @endphp
                <tr>
                    <td>{{ isset($inputData['minat']) ? ucwords(str_replace('_', ' ', $inputData['minat'])) : '-' }}</td>
                    <td>{{ isset($inputData['bakat']) ? ucwords(str_replace('_', ' ', $inputData['bakat'])) : '-' }}</td>
                    <td>{{ isset($inputData['prospek_karir']) ? ucwords(str_replace('_', ' ', $inputData['prospek_karir'])) : '-' }}</td>
                    <td style="text-align: center; font-weight: 600; color: #5B6FFF;">{{ $avgNilai }}</td>
                </tr>
            </tbody>
        </table>

        <!-- Criteria Values Section -->
        <h2 class="section-title">Nilai Kriteria</h2>
        <div class="criteria-grid">
            @if($result->criteria_values)
            @php
                $criteriaValues = is_array($result->criteria_values) ? $result->criteria_values : json_decode($result->criteria_values, true);
                // Set default values jika tidak ada
                $minatValue = isset($criteriaValues['minat']) ? number_format($criteriaValues['minat'], 2) : '0.00';
                $bakatValue = isset($criteriaValues['bakat']) ? number_format($criteriaValues['bakat'], 2) : '0.00';
                $karirValue = isset($criteriaValues['prospek_karir']) ? number_format($criteriaValues['prospek_karir'], 2) : '0.00';
                $akademikValue = isset($criteriaValues['akademik']) ? number_format($criteriaValues['akademik'], 2) : '0.00';
            @endphp
            <div class="criteria-card">
                <div class="criteria-icon">Minat</div>
                <div class="criteria-label">Minat</div>
                <div class="criteria-value">{{ $minatValue }}</div>
            </div>
            <div class="criteria-card">
                <div class="criteria-icon">Bakat</div>
                <div class="criteria-label">Bakat</div>
                <div class="criteria-value">{{ $bakatValue }}</div>
            </div>
            <div class="criteria-card">
                <div class="criteria-icon">Karir</div>
                <div class="criteria-label">Prospek Karir</div>
                <div class="criteria-value">{{ $karirValue }}</div>
            </div>
            <div class="criteria-card">
                <div class="criteria-icon">Akademik</div>
                <div class="criteria-label">Akademik</div>
                <div class="criteria-value">{{ $akademikValue }}</div>
            </div>
            @else
            <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #999;">
                Data kriteria tidak tersedia
            </div>
            @endif
        </div>

        <!-- Weights Section -->
        <h2 class="section-title">Bobot Kriteria (Weight)</h2>
        <table class="weights-table">
            <thead>
                <tr>
                    <th>Kriteria</th>
                    <th style="text-align: center; width: 60%;">Visualisasi</th>
                    <th style="text-align: right; width: 20%;">Bobot</th>
                </tr>
            </thead>
            <tbody>
                @if($result->weights)
                @php
                    $weights = is_array($result->weights) ? $result->weights : json_decode($result->weights, true);
                    $minatWeight = isset($weights['minat']) ? floatval($weights['minat']) : 0;
                    $bakatWeight = isset($weights['bakat']) ? floatval($weights['bakat']) : 0;
                    $karirWeight = isset($weights['prospek_karir']) ? floatval($weights['prospek_karir']) : 0;
                    $akademikWeight = isset($weights['akademik']) ? floatval($weights['akademik']) : 0;
                @endphp
                <tr>
                    <td><strong>Minat</strong></td>
                    <td style="text-align: center;">
                        <div class="weight-bar">
                            <div class="weight-bar-fill" style="width: {{ $minatWeight }}%"></div>
                        </div>
                    </td>
                    <td style="text-align: right;"><strong>{{ $minatWeight }}%</strong></td>
                </tr>
                <tr>
                    <td><strong>Bakat</strong></td>
                    <td style="text-align: center;">
                        <div class="weight-bar">
                            <div class="weight-bar-fill" style="width: {{ $bakatWeight }}%"></div>
                        </div>
                    </td>
                    <td style="text-align: right;"><strong>{{ $bakatWeight }}%</strong></td>
                </tr>
                <tr>
                    <td><strong>Prospek Karir</strong></td>
                    <td style="text-align: center;">
                        <div class="weight-bar">
                            <div class="weight-bar-fill" style="width: {{ $karirWeight }}%"></div>
                        </div>
                    </td>
                    <td style="text-align: right;"><strong>{{ $karirWeight }}%</strong></td>
                </tr>
                <tr>
                    <td><strong>Akademik</strong></td>
                    <td style="text-align: center;">
                        <div class="weight-bar">
                            <div class="weight-bar-fill" style="width: {{ $akademikWeight }}%"></div>
                        </div>
                    </td>
                    <td style="text-align: right;"><strong>{{ $akademikWeight }}%</strong></td>
                </tr>
                <tr class="total-row">
                    <td><strong>Total</strong></td>
                    <td style="text-align: center;">
                        <div class="weight-bar">
                            <div class="weight-bar-fill" style="width: 100%"></div>
                        </div>
                    </td>
                    <td style="text-align: right;"><strong>100%</strong></td>
                </tr>
                @else
                <tr>
                    <td colspan="3" style="text-align: center; color: #999;">Data bobot tidak tersedia</td>
                </tr>
                @endif
            </tbody>
        </table>

        <!-- Page Break before Recommendation -->
        <div class="page-break"></div>

        <!-- Recommendation Section -->
        @if($result->rekomendasi_prodi)
        <h2 class="section-title">Rekomendasi Program Studi</h2>
        @php
            $prodiRec = $result->rekomendasi_prodi;
            if (is_string($prodiRec)) {
                $prodiRec = json_decode($prodiRec, true);
            }
            $prodiScore = isset($prodiRec['score']) ? floatval($prodiRec['score']) : 0;
        @endphp
        <div class="recommendation-card">
            <div class="recommendation-title">Program Studi Rekomendasi</div>
            <div class="recommendation-prodi">{{ $prodiRec['nama_prodi'] ?? 'Program Studi Belum Tersedia' }}</div>
            
            <div class="recommendation-grid">
                <div class="recommendation-stat">
                    <div class="recommendation-stat-label">Skor Kesesuaian</div>
                    <div class="recommendation-stat-value">{{ number_format($prodiScore, 2) }}/100</div>
                </div>
                <div class="recommendation-stat">
                    <div class="recommendation-stat-label">Tingkat Kesesuaian</div>
                    <div class="recommendation-stat-value">
                        {{ $prodiScore >= 80 ? 'Sangat Sesuai' : ($prodiScore >= 70 ? 'Sesuai' : ($prodiScore >= 60 ? 'Cukup Sesuai' : 'Kurang Sesuai')) }}
                    </div>
                </div>
            </div>

            @if(isset($prodiRec['details']) && is_array($prodiRec['details']))
            <div class="details-grid">
                @foreach($prodiRec['details'] as $key => $detail)
                <div class="detail-item">
                    <div class="detail-label">{{ ucwords(str_replace('_', ' ', $key)) }}</div>
                    <div class="detail-value">{{ number_format($detail['weighted'] ?? 0, 2) }}</div>
                    <div style="font-size: 10px; margin-top: 5px; opacity: 0.8;">Nilai: {{ number_format($detail['score'] ?? 0, 2) }} • Weight: {{ number_format(($detail['weight'] ?? 0) * 100, 0) }}%</div>
                    <div class="score-bar">
                        <div class="score-bar-fill" style="width: {{ min($detail['score'] ?? 0, 100) }}%"></div>
                    </div>
                </div>
                @endforeach
            </div>
            @endif
        </div>
        @endif

        <!-- Footer -->
        <div class="footer">
            <div class="footer-text">
                Dokumen ini digenerate otomatis oleh sistem PILIHANKU
            </div>
            <div class="footer-note">
                © {{ date('Y') }} - Sistem Pendukung Keputusan Pemilihan Program Studi
            </div>
        </div>
    </div>
</body>
</html>
